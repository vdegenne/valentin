<!--
@license
Copyright (c) 2017 Valentin Degenne. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/vdegenne/valentin/LICENSE.txt
-->
<link rel="import" href="../../../iron-ajax/iron-request.html">

<script>
(function () {

  'use strict';

  window.Valentin = {

    request: function (optionsArg, fn)
    {
      let r = document.createElement('iron-request');
      r.completes.then(function (request) {
        let feedback = request.response;
        fn(request, feedback);
      }).catch(err => console.log(err));


      let options = { /* with defaults */
        method: 'GET',
        handleAs: 'json',
        headers: {}
      };

      switch (typeof optionsArg)
      {
        case 'string':
        options.url = optionsArg;
        break;

        case 'object':
        for (var o in optionsArg) {

          if (o === 'headers') {
            options[o] = options[o] || {};
            for (var so in optionsArg[o]) {
              options[o][so] = optionsArg[o][so]
            }
            continue;
          }
          options[o] = optionsArg[o];
        }

        let newHeaders = Object.create(null);
        for (var key in options.headers) {
          newHeaders[key.toLowerCase()] = options.headers[key];
        }
        let headers = options.headers = newHeaders;

        if (!headers['content-type']
        && ['post', 'put'].indexOf(options.method.toLowerCase()) > -1
        &&  !(options.body instanceof FormData))
        {
          options.headers['content-type'] = 'application/x-www-form-urlencoded';
        }

        break;
      }

      r.send(options);
    },



    toast: function (element, message, success) {
      element.dispatchEvent(
        new CustomEvent('toast',
        { detail: { text: message, success: success },
        bubbles: true, composed: true})
      )
    }
  }

})();
</script>
