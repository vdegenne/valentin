<link rel="import" href="boot.html">

<script>
(function () {


  let translations;
  let forEach = Array.prototype.forEach;
  let skipNodeNames = [
    'STYLE',
    'CUSTOM-STYLE',
    'LINK'
  ];

  function translate (element) {

    if (skipNodeNames.indexOf(element.nodeName) >= 0) {
      return;
    }

    forEach.call(element.children, c => {
      translate(c);
    });

    let found;
    if (found = /(TR\d+)(\s|$)/.exec(element.classList)) {

      let founds = translations.filter(function (t) {
        return (`TR${t.tr_id}` == found[0]);
      });

      if (founds.length > 0) {
        if (founds.length > 1) {
          console.warn('several translations for the same tag (taking the first found).');
        }
        element.innerText = founds[0].translation;
      }
    }
  }

  function translatePage (page, lang = null, from = document.body) {

    let uri = `/translations?pagename=${page}`;
    if (lang !== null) {
      uri += `&lang=${lang}`;
    }

    Vcms.request(uri, (request, feedback) => {
      if (feedback.success) {
        translations = feedback.data;
        translate(from, feedback.data);
      }
    });
  }

  Vcms.translatePage = translatePage;

  Vcms.request('/translations?action=informations', (request, feedback) => {
    if (feedback.success) {
      let pathcrumbs = window.location.pathname.substr(1).split('/');

      let lang =
         (feedback.data.availableLangs.indexOf(pathcrumbs[0]) > -1)
            ? pathcrumbs.shift()
            : null;

      translatePage(pathcrumbs.join('/'), lang);
    }
  });

})();
</script>