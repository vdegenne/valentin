<link rel="import" href="../utils/polymer-helpers.html">

<script>
  (function () {

     /* monostate */
    let _data = {};
    let _els = [];

    let _setBut = function (except) {
      _els.forEach(e => {
        if (e !== except) {
          e.AppData = _data;
        }
      });
    };

    let _notify = function (path) {
      _els.forEach(e => {
          e.notify(path);
      });
    };


    Valentin.AppDataElement = class extends Polymer.Element {

      static get properties () {
        return {
          AppData: {
            type: Object
          }
        }
      }

//      static get observers () {
//        return ['_AppDataChanged(AppData.*)']
//      }
//
//      _AppDataChanged () {
//        console.log(this.AppData);
//        _setData(this.AppData, this);
//      }

      notify (path) {
        this.notifyPath(`AppData.${path}`);
      }

      connectedCallback () {
        super.connectedCallback();
        this.AppData = _data;
        _els.push(this);
      }

      disconnectedCallback () {
        super.disconnectedCallback();

        _els.splice(_els.indexOf(this), 1);
      }


      setAppData (path, value) {
        let pathcrumbs = path.split('.');
        let crumb = this.AppData;
        for (let i=0; i<pathcrumbs.length; ++i) {
          if (i === pathcrumbs.length-1) {
            crumb[pathcrumbs[i]] = value;
            break;
          }

          if (crumb[pathcrumbs[i]] === undefined) {
              crumb[pathcrumbs[i]] = {};
            crumb = crumb[pathcrumbs[i]];
          }
          else {
            crumb = crumb[pathcrumbs[i]];
          }
        }
        crumb = value;

        _data = this.AppData;

        _setBut(this);
        _notify(path);
      }
    };


  })();
</script>